<!DOCTYPE html>
<html>
    <head>
        <title>REGGAE-LYRICS.COM Online Reggae Dub Sampler v0.2</title>
        <meta name="author" content="Jorge Matricali <jorge.matricali@gmail.com>">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
        <style>
            body {
                background-color: #000;
            }
            #sampler-machine {
                background: url(images/metal-bg.jpg);
                -webkit-background-size: cover;
                -moz-background-size: cover;
                -o-background-size: cover;
                background-size: cover;
                min-width: 480px;
                min-height: 340px;

                width: 100%;
                height: 100%;

                max-width: 750px;
                max-height: 500px;
                margin: auto;
            }
            
            #sampler-machine:before {
                content: ' ';
                position: relative;
                background-color: #ff5900;
                width: 10px;
                height: 100%;
            }
            
            #sampler {
                margin: 5%;
                padding-top: 40px;
                padding-bottom: 50px;
            }
            .imageContainer {
                position: relative;
                width: 23%;
                padding-bottom: 25%;
                float: left;
                height: 0;
                margin: 1%;
            }
            .btn-sampler {
                width: 100%;
                height: 100%;
                position: absolute;
                left: 0;
                border-radius: 10px;
                text-shadow: #333 5px; 

                background: #8f787e;
                background-image: -webkit-linear-gradient(top, #8f787e, #7d4c4f);
                background-image: -moz-linear-gradient(top, #8f787e, #7d4c4f);
                background-image: -ms-linear-gradient(top, #8f787e, #7d4c4f);
                background-image: -o-linear-gradient(top, #8f787e, #7d4c4f);
                background-image: linear-gradient(to bottom, #8f787e, #7d4c4f);
                -webkit-border-radius: 10;
                -moz-border-radius: 10;
                border-radius: 10px;
                -webkit-box-shadow: 0px 4px 2px #666666;
                -moz-box-shadow: 0px 4px 2px #666666;
                box-shadow: 0px 4px 2px #666666;
            }
            .btn-sampler:hover {
                background: #ff2600;
                background-image: -webkit-linear-gradient(top, #ff2600, #ff5900);
                background-image: -moz-linear-gradient(top, #ff2600, #ff5900);
                background-image: -ms-linear-gradient(top, #ff2600, #ff5900);
                background-image: -o-linear-gradient(top, #ff2600, #ff5900);
                background-image: linear-gradient(to bottom, #ff2600, #ff5900);
                text-decoration: none;
            }
            #speaker {
                display: none;
                content: ' ';
                background: url(images/reggae-speaker.png);
                background-size: 100% 100%;
                position: relative;
                width: 64px;
                height: 64px;
                top: 5%;
                left: 5%;
            }
        </style>
    </head>
    <body>
        <div id="sampler-machine">
            <div id="sampler" style="display: none;" class="container-fluid">
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="1">Sampler 1</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="2">Sampler 2</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="3">Sampler 3</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="4">Sampler 4</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="5">Sampler 5</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="6">Sampler 6</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="7">Sampler 7</button>
                </div>
                <div class="imageContainer col-md-4 col-xs-6">
                    <button class="btn btn-sampler" data-sampler-id="8">Sampler 8</button>
                </div>
            </div>
            <div id="speaker"></div>
        </div>
        <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
        <script>
            function BufferLoader(context, urlList, callback) {
                this.context = context;
                this.urlList = urlList;
                this.onload = callback;
                this.bufferList = new Array();
                this.loadCount = 0;
            }

            BufferLoader.prototype.loadBuffer = function(url, index) {
                // Load buffer asynchronously
                var request = new XMLHttpRequest();
                request.open("GET", url, true);
                request.responseType = "arraybuffer";

                var loader = this;

                request.onload = function() {
                    // Asynchronously decode the audio file data in request.response
                    loader.context.decodeAudioData(
                            request.response,
                            function(buffer) {
                                if (!buffer) {
                                    alert('error decoding file data: ' + url);
                                    return;
                                }
                                loader.bufferList[index] = buffer;
                                if (++loader.loadCount == loader.urlList.length)
                                    loader.onload(loader.bufferList);
                            },
                            function(error) {
                                console.error('decodeAudioData error', error);
                            }
                    );
                };

                request.onerror = function() {
                    alert('BufferLoader: XHR error');
                };

                request.send();
            }

            BufferLoader.prototype.load = function() {
                for (var i = 0; i < this.urlList.length; ++i)
                    this.loadBuffer(this.urlList[i], i);
            }

            function arrayHasOwnIndex(array, prop) {
                return array.hasOwnProperty(prop) && /^0$|^[1-9]\d*$/.test(prop) && prop <= 4294967294; // 2^32 - 2
            }
        </script>
        <script>
            var context;
            var gainNode;
            var bufferLoader;
            var bufferL = new Array();
            var sources = new Array();

            window.onload = init;
            window.onerror = onError;

            function onError(e) {
                console.log(e);
            }

            function init() {
                console.log('Loading sampler...');
                // Fix up prefixing
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                context = new AudioContext();
                if (context) {
                    gainNode = context.createGain ? context.createGain() : context.createGainNode();
                    gainNode.connect(context.destination);
                    gainNode.gain.value = 0.7;
                    
                    console.log("AudioContext created successfully.\nLoading sounds...");
                    bufferLoader = new BufferLoader(
                            context,
                            [
                                'audio/AirHorn-Reggae.mp3',
                                'audio/Triple-Horn.mp3',
                                //'audio/Mad-Horn.mp3',
                                //'audio/Mortal-Pulop.mp3',
                                'audio/Wooy.mp3',
                                'audio/Boat-Land-Man.mp3',
                                'audio/Ya-Man.mp3',
                                'audio/Yes-JAH.mp3',
                                'audio/The-Rockers-to-Rockers.mp3',
                                'audio/Laseers002.wav',
                                'audio/Laseers003.wav'
                            ],
                            finishedLoading
                            );

                    bufferLoader.load();
                    return 0;
                }
                console.log('ERROR: The sampler cannot be started.');
            }

            function finishedLoading(bufferList) {
                // Create two sources and play them both together.
                //bufferList.forEach(function(entry) {
                //console.log(entry);

                //});
                for (index = 0; index < bufferList.length; ++index) {
                    bufferL.push(bufferList[index]);
                    //sources[index] = context.createBufferSource();
                    //sources[index].buffer = bufferList[index];
                    //sources[index].connect(context.destination);
                }
                console.log("Sounds loaded.");
                $("#sampler").show();
            }

            function playSound(buffer, time) {
                var source = context.createBufferSource();
                source.buffer = buffer;
                source.connect(gainNode);
                source.start(time);
            }

            function playSlot(slot_id) {
                if (bufferL.hasOwnProperty(slot_id)) {
                    playSound(bufferL[slot_id], 0);
                }
            }

            $("#sampler button").click(function() {
                var id = $(this).attr("data-sampler-id");
                if (id) {
                    playSlot(id);
                }
            });
            
            $(document).keypress(function(e) {
                //console.log(e.which);
                switch (e.which) {
                    case 49:
                        playSlot(0);
                        break;
                    case 50:
                        playSlot(1);
                        break;
                    case 51:
                        playSlot(2);
                        break;
                    case 52:
                        playSlot(3);
                        break;
                    case 53:
                        playSlot(4);
                        break;
                    case 54:
                        playSlot(5);
                        break;
                    case 55:
                        playSlot(6);
                        break;
                    case 56:
                        playSlot(7);
                        break;
                    case 57:
                        playSlot(8);
                        break;
                    case 115:
                        osc.play(0);
                        break;
                }
            });
        </script>
    </body>
</html>
